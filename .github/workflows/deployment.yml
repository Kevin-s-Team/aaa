name: CD-deployment

on:  
  workflow_dispatch:

jobs:
  deploy-to-gae:

    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v3
    # build angular frontend and move the result to gae/static
    - uses: actions/setup-node@v3
      with:
        node-version: 20.x
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    - run: npm ci
      working-directory: ./frontend
    - run: npm run build
      working-directory: ./frontend
    - run: mv ./frontend/dist/my-app gae/static

    # move the python backend to gae
    - run: mv backend/* gae

    # deploy the content of the gae dir to google app engine
    - uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
    - uses: 'google-github-actions/deploy-appengine@v1'
      with:
        working_directory: gae
        version: the-only-one
